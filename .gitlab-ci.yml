stages:
    - prepare
    - generate
    - deploy

gen-wraps:
    stage: prepare
    image: python:latest
    script: ./gen.py wraps wraps_gen https://robinmarchart.gitlab.io/meson-wraps/wraps
    artifacts:
        paths:
            - wraps_gen

gen-site:
    stage: generate
    image: robinmarchart/meson-builder:site-builder
    script: 
        - cd wraps-site
        - yarn install --frozen-lockfile --check-files --non-interactive
        - node node_modules/.bin/gatsby build --prefix-paths
    artifacts:
        paths:
            - wraps-site/public
    dependencies:
        - gen-wraps
    cache:
        policy: pull-push
        key: node_modules
        paths:
            - wraps-site/node_modules

pages:
    stage: deploy
    dependencies:
        - gen-site
        - gen-wraps
    artifacts:
        paths:
            - public
    script: 
        - cp -r wraps-site/public ./
        - cp -r wraps_gen public/
        - mv public/wraps_gen public/wraps
    rules:
        - if: $CI_COMMIT_BRANCH == "master"
    

